@{
    ViewData["Title"] = "Used Cars";
    var usedCars = new List<(int Id, string Title, string Image, string Brand, string BodyType, string Color, decimal Price)>
    {
        (1, "2021 Mahindra XUV700", "/images/images(3).jpg", "Mahindra", "SUV", "White", 29999),
        (2, "2021 Nissan Ariya", "/images/e869d5ebe2e741119b15964925b077a6.jpg", "Nissan", "Electric", "Blue", 45999),
        (3, "2021 Nissan Ariya Sport", "/images/images(2).jpg", "Nissan", "Electric", "Red", 61999),
        (4, "2021 Rolls-Royce Cullinan", "/images/41X0G5+nddL._AC_UF1000,1000_QL80_.jpg", "Rolls-Royce", "Luxury", "Black", 129999),
        (5, "2021 Nissan Ariya Black", "/images/37716ecbb91240cfa348d8186273b3d9.jpg", "Nissan", "Electric", "Black", 48999)
    };
}

<div class="container-fluid p-0">
    <div class="position-relative">
        <div class="bg-light" style="background-color: #f5e6d8 !important; min-height: 200px;"></div>

        <div class="container position-relative" style="margin-top: -100px;">
            <div class="row justify-content-center mb-5">
                <div class="col-md-8 text-center">
                    <div class="card border-light shadow-sm">
                        <div class="card-body">
                            <h2 class="card-title text-center mb-4" style="color: #8B4513; font-weight: bold;">Choose your car</h2>
                            <form id="filterForm" method="get" action="@Url.Action("UsedCars", "Home")">
                                <div class="d-flex justify-content-center gap-3 flex-wrap">
                                    <div class="dropdown">
                                        <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                            @(string.IsNullOrEmpty(ViewBag.SelectedBodyType) ? "Body Type" : ViewBag.SelectedBodyType)
                                        </button>
                                        <ul class="dropdown-menu">
                                            <li><a class="dropdown-item filter-item" data-filter="bodyType" data-value="">All Body Types</a></li>
                                            @foreach (var bodyType in ViewBag.BodyTypes)
                                            {
                                                <li><a class="dropdown-item filter-item @(bodyType == ViewBag.SelectedBodyType ? "active" : "")" 
                                                      data-filter="bodyType" data-value="@bodyType">@bodyType</a></li>
                                            }
                                        </ul>
                                        <input type="hidden" name="bodyType" id="bodyTypeInput" value="@ViewBag.SelectedBodyType" />
                                    </div>
                                    <div class="dropdown">
                                        <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                            @(string.IsNullOrEmpty(ViewBag.SelectedBrand) ? "Brand" : ViewBag.SelectedBrand)
                                        </button>
                                        <ul class="dropdown-menu">
                                            <li><a class="dropdown-item filter-item" data-filter="brand" data-value="">All Brands</a></li>
                                            @foreach (var brand in ViewBag.Brands)
                                            {
                                                <li><a class="dropdown-item filter-item @(brand == ViewBag.SelectedBrand ? "active" : "")" 
                                                      data-filter="brand" data-value="@brand">@brand</a></li>
                                            }
                                        </ul>
                                        <input type="hidden" name="brand" id="brandInput" value="@ViewBag.SelectedBrand" />
                                    </div>
                                    <div class="dropdown">
                                        <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                            @(string.IsNullOrEmpty(ViewBag.SelectedPriceRange) ? "Price" : ViewBag.SelectedPriceRange)
                                        </button>
                                        <ul class="dropdown-menu">
                                            <li><a class="dropdown-item filter-item" data-filter="priceRange" data-value="">All Prices</a></li>
                                            <li><a class="dropdown-item filter-item @("Under $30,000" == ViewBag.SelectedPriceRange ? "active" : "")" 
                                                  data-filter="priceRange" data-value="Under $30,000">Under $30,000</a></li>
                                            <li><a class="dropdown-item filter-item @("$30,000 - $50,000" == ViewBag.SelectedPriceRange ? "active" : "")" 
                                                  data-filter="priceRange" data-value="$30,000 - $50,000">$30,000 - $50,000</a></li>
                                            <li><a class="dropdown-item filter-item @("$50,000 - $100,000" == ViewBag.SelectedPriceRange ? "active" : "")" 
                                                  data-filter="priceRange" data-value="$50,000 - $100,000">$50,000 - $100,000</a></li>
                                            <li><a class="dropdown-item filter-item @("Over $100,000" == ViewBag.SelectedPriceRange ? "active" : "")" 
                                                  data-filter="priceRange" data-value="Over $100,000">Over $100,000</a></li>
                                        </ul>
                                        <input type="hidden" name="priceRange" id="priceRangeInput" value="@ViewBag.SelectedPriceRange" />
                                    </div>
                                    <div class="dropdown">
                                        <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                            @(string.IsNullOrEmpty(ViewBag.SelectedColor) ? "Color" : ViewBag.SelectedColor)
                                        </button>
                                        <ul class="dropdown-menu">
                                            <li><a class="dropdown-item filter-item" data-filter="color" data-value="">All Colors</a></li>
                                            @foreach (var color in ViewBag.Colors)
                                            {
                                                <li><a class="dropdown-item filter-item @(color == ViewBag.SelectedColor ? "active" : "")" 
                                                      data-filter="color" data-value="@color">@color</a></li>
                                            }
                                        </ul>
                                        <input type="hidden" name="color" id="colorInput" value="@ViewBag.SelectedColor" />
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Car Listings -->
            <div class="row justify-content-center">
                <div class="col-md-10">
                    @foreach (var car in usedCars)
                    {
                        // Check if this car should be displayed based on current filters
                        bool showCar = (string.IsNullOrEmpty(ViewBag.SelectedBrand) || car.Brand == ViewBag.SelectedBrand) &&
                                      (string.IsNullOrEmpty(ViewBag.SelectedBodyType) || car.BodyType == ViewBag.SelectedBodyType) &&
                                      (string.IsNullOrEmpty(ViewBag.SelectedColor) || car.Color == ViewBag.SelectedColor) &&
                                      (string.IsNullOrEmpty(ViewBag.SelectedPriceRange) || 
                                          (ViewBag.SelectedPriceRange == "Under $30,000" && car.Price < 30000) ||
                                          (ViewBag.SelectedPriceRange == "$30,000 - $50,000" && car.Price >= 30000 && car.Price <= 50000) ||
                                          (ViewBag.SelectedPriceRange == "$50,000 - $100,000" && car.Price > 50000 && car.Price <= 100000) ||
                                          (ViewBag.SelectedPriceRange == "Over $100,000" && car.Price > 100000));
                        
                        if (showCar)
                        {
                            <a href="/Home/CarDetails?carId=@car.Id" class="text-decoration-none text-dark">
                                <div class="card mb-4 shadow-sm hover-shadow" style="cursor: pointer;">
                                    <div class="card-body p-0">
                                        <div class="row g-0">
                                            <div class="col-md-5">
                                                <img src="@car.Image" class="img-fluid rounded-start" alt="@car.Title">
                                            </div>
                                            <div class="col-md-7">
                                                <div class="card-body position-relative p-4">
                                                    <button class="btn btn-sm position-absolute top-0 end-0 mt-2 me-2 border-0 favorite-btn">
                                                        <i class="bi bi-heart"></i>
                                                    </button>
                                                    <h5 class="card-title">@car.Title</h5>
                                                    <p class="card-text mb-1">43,629 mi</p>
                                                    <p class="card-text mb-1"><strong>$@car.Price.ToString("#,##0")</strong></p>
                                                    <p class="card-text mb-1 deal-rating">Fair Deal</p>
                                                    <p class="card-text mb-1">Body Type: @car.BodyType</p>
                                                    <p class="card-text mb-1">Color: @car.Color</p>
                                                    <p class="card-text mb-1">
                                                        <span class="me-2">4.9</span>
                                                        <span>(1,450 reviews)</span>
                                                    </p>
                                                    <p class="card-text">Countryside, IL</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </a>
                        }
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {
            // Handle favorite button clicks
            $('.favorite-btn').click(function (e) {
                e.preventDefault();
                e.stopPropagation();
                $(this).find('i').toggleClass('bi-heart bi-heart-fill text-danger');
            });
            
            // Handle filter selections
            $('.filter-item').click(function (e) {
                e.preventDefault();
                const filter = $(this).data('filter');
                const value = $(this).data('value');
                
                // Update the hidden input value
                $(`#${filter}Input`).val(value);
                
                // Update the dropdown button text
                const buttonText = value === '' ? 
                    filter === 'bodyType' ? 'Body Type' : 
                    filter === 'brand' ? 'Brand' : 
                    filter === 'priceRange' ? 'Price' : 'Color' 
                    : value;
                
                $(this).closest('.dropdown').find('button').text(buttonText);
                
                // Submit the form
                $('#filterForm').submit();
            });
        });
    </script>
    <style>
        .hover-shadow:hover {
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
            transition: all 0.2s ease-in-out;
        }
        
        .dropdown-item.active {
            background-color: #8B4513;
            color: white;
        }
    </style>
}